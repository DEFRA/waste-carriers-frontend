<%= render 'shared/content_for_pages' %>

<main id="content" role="main" class="group">
	<article role="article" class="group">
	<section>
      <div class="inner">
      <div class="col-1">
      
	<% content_for :page_title, createTitle('.heading') %>

	<!-- Usefull for showing default messages -->
	<% if alert %><%= alert %><% end %>

	<aside>
		<div class="step"><%= t '.step' %></div>

		<!-- WF X.X.X -->
		<div id="payment" data-journey="waste-carriers-registration:refunds">

			<fieldset>
				<legend><%= t '.heading' %></legend>
				
				<table class="" summary='This table details the orders available for a refund'>
					<thead class="">
						<tr>
							<th class="">Date</th>
							<th class="">Order Code</th>
							<th class="">Type</th>
							<th class="">Â£</th>
							<th class=""></th>
						</tr>
					</thead>
					<tbody>
						<% regCount = 1; %>
						<% if @registration.finance_details.size > 0 \
							&& @registration.finance_details.first.payments \
							&& @registration.finance_details.first.payments.size > 0 %>
							<% @registration.finance_details.first.payments.each do |payment| %>
							    <% if !isARefund(payment) %>
								<tr class="<% if regCount.odd? %> solid-box<% else %> lighter-box<% end %>">
									<td class=""><%= payment.dateReceived %></td>
									<td class="">
									<% if hasOrderKey(payment) %>
									    <%= payment.orderKey %>
									<% else %>
									    <%= t 'registrations.form.not_applicable' %>
									<% end %>
									</td>
									<td class=""><%= t('payment_types.'+payment.paymentType) %></td>
									<td class=""><%= Money.new(payment.amount) %></td>
									<td class="">
									<% isReversalAppropriateForMe = false 
									
									isPayment = current_agency_user.has_role? :Role_ncccPayment, AgencyUser
									isFinanceBasic = current_agency_user.has_role? :Role_financeBasic, AgencyUser
		    						isFinanceAdmin = current_agency_user.has_role? :Role_financeAdmin, AgencyUser
		    						
		    						if isPayment
		    						  # Use can only reverse types:
		    						  # Cheque, cash, postal order payment,
									  # Refused cheque?
									  if payment.paymentType == "CASH" \
									  		or payment.paymentType == "CHEQUE" \
									  		or payment.paymentType == "POSTALORDER" 
		    						    isReversalAppropriateForMe = true
		    						  end
		    						end
		    						
		    						if isFinanceBasic
		    						  # Use can only reverse types:
		    						  # Bank transfer payment
		    						  if payment.paymentType == "BANKTRANSFER"
		    						    isReversalAppropriateForMe = true
		    						  end
		    						end
		    						
		    						if isFinanceAdmin
		    						  # Use can only reverse types:
		    						  # Worldpay_missed
		    						  if payment.paymentType == "WORLDPAY_MISSED"
		    						    isReversalAppropriateForMe = true
		    						  end
		    						end
		    						
		    						isAvailableForReversal = true
		    						@registration.finance_details.first.payments.each do |otherPayment|
		    						  # Check other payments for a matching reversal, 
		    						  # ie a payment with a matching orderkey appended with reversal
		    						  if (payment.orderKey.to_s + '_REVERSAL') == otherPayment.orderKey
		    						    # Another payment found, this this payment is n/a for a reversal
		    						    isAvailableForReversal = false
		    						  end
		    						end
									
									%>
									<% if isReversalAppropriateForMe and isAvailableForReversal %>
									    <%= link_to t('registrations.form.selectReversal_button_label'), {controller: 'payment', action: 'newReversal', id: @registration.uuid, orderCode: payment.orderKey }, class: 'link_to' %>
									<% elsif !isAvailableForReversal %>
									    <%= t '.alreadyReversed' %>
									<% elsif payment.orderKey.to_s.include? '_REVERSAL' %>
									    <%= t 'registrations.form.not_applicable' %>
									<% else %>
									    <%= t 'registrations.form.not_applicable' %>
									<% end %>
									</td>
								</tr>
								<% end %>
							<% regCount = regCount + 1; %>
							<% end %>
						<% else %>
							<tr class="solid-box">
								<td class="">No Payment History</td>
								<td class=""> </td>
								<td class=""> </td>
								<td class=""> </td>
								<td class=""> </td>
							</tr>
						<% end %>
					</tbody>
				</table>
				
				<br/>
				<br/>

				<div class="inline">
				    <noscript>
				        <%= content_tag :p, t('registrations.back_link_unavailable') %>
				    </noscript>
				    <%= link_to t('registrations.form.back_button_label'), :paymentstatus, :class => 'link_to' %>
				</div>
				
				<br/>
				<br/>
				<br/>
				
			</fieldset>
			
		</div>
	
	</div>
      </div>
    </section>

    <aside role='note'>
      <div class="inner">
        <div class="col-2">
         <%= render "shared/current_user" %>
        </div>
      </div>
    </aside>

	</article>
</main>