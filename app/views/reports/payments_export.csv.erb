<% headings = [
  t('reports.fields.reg_identifier'),
  t('reports.fields.company_name'),
  t('reports.fields.status'),
  t('reports.fields.route'),
  t('reports.fields.transaction_date'),
  t('reports.fields.order_code'),
  t('reports.fields.charge_type'),
  t('reports.fields.charge_amount'),
  t('reports.fields.charge_updated_by'),
  t('reports.fields.payment_type'),
  t('reports.fields.reference'),
  t('reports.fields.payment_amount'),
  t('reports.fields.comment'),
  t('reports.fields.payment_updated_by'),
  t('reports.fields.balance')
] %>
<% # Apologies for the formatting in this file, however any formatting such as %>
<% # indenting or line spaces get directly translated to the exported CSV file. %>
<%= CSV.generate_line(headings, { :row_sep => nil, :force_quotes => true }).html_safe %>
<% @registrations.each do |registration| %>
<% registration.finance_details.first.orders.each do |order| %>
<% order.order_items.each do |order_item| %>
<% related_payments = registration.finance_details.first.payments.to_a.find_all{ |payment| payment.orderKey == order.orderCode } %>
<% if related_payments.nil? || related_payments.empty? %>
<% row = [] %>
<% row << registration.regIdentifier %>
<% row << registration.companyName %>
<% row << registration.metaData.first.status %>
<% row << registration.metaData.first.route %>
<% row << format_time(order.dateCreated) %>
<% row << order.orderCode %>
<% row << order_item.type %>
<% row << money_value_without_currency_symbol_and_with_pence_part(order_item.amount) %>
<% row << order.updatedByUser %>
<% row << order.paymentMethod %>
<% row << order_item.reference %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << money_value_without_currency_symbol_and_with_pence_part(registration.finance_details.first.balance) %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% else %>
<% related_payments.each do |payment| %>
<% row = [] %>
<% row << registration.regIdentifier %>
<% row << registration.companyName %>
<% row << registration.metaData.first.status %>
<% row << registration.metaData.first.route %>
<% row << format_time(order.dateCreated) %>
<% row << order.orderCode %>
<% row << order_item.type %>
<% row << money_value_without_currency_symbol_and_with_pence_part(order_item.amount) %>
<% row << order.updatedByUser %>
<% row << payment.paymentType %>
<% row << order_item.reference %>
<% row << money_value_without_currency_symbol_and_with_pence_part(payment.amount) %>
<% row << payment.comment %>
<% row << payment.updatedByUser %>
<% row << money_value_without_currency_symbol_and_with_pence_part(registration.finance_details.first.balance) %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<% end %>
<% end %>
<% end %>
<% order_codes = registration.finance_details.first.orders.collect { |order| order.orderCode } %>
<% unrelated_payments = registration.finance_details.first.payments.to_a.find_all{ |payment| !order_codes.include? payment.orderKey} %>
<% unrelated_payments.each do |payment| %>
<% row = [] %>
<% row << registration.regIdentifier %>
<% row << registration.companyName %>
<% row << registration.metaData.first.status %>
<% row << registration.metaData.first.route %>
<% row << format_time(payment.dateReceived) %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << payment.paymentType %>
<% row << payment.registrationReference %>
<% row << money_value_without_currency_symbol_and_with_pence_part(payment.amount) %>
<% row << payment.comment %>
<% row << payment.updatedByUser %>
<% row << money_value_without_currency_symbol_and_with_pence_part(registration.finance_details.first.balance) %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<%end%>
