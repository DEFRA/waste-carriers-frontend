<% registrationHeaders = [
  "regIdentifier",
  "companyName"
] %>
<% metaDataHeaders = [
  "dateRegistered",
  "status",
] %>
<% orderHeaders = [
  "orderCode",
  "updatedByUser",
] %>
<% orderItemHeaders = [
  "amount",
  "description"
] %>
<% paymentHeaders = [
  "amount",
  "paymentType",
  "updatedByUser",
  "comment"
] %>
<% # Apologies for the formatting in this file, however any formatting such as %>
<% # indenting or line spaces get directly translated to the exported CSV file. %>
<%= CSV.generate_line(registrationHeaders + metaDataHeaders + orderHeaders + orderItemHeaders + paymentHeaders, { :row_sep => nil, :force_quotes => true }).html_safe %>
<% @registrations.each do |registration| %>
<% reg_section = registration.attributes.values_at(*registrationHeaders.map {|x| x.to_sym}) %>
<% metadata_section = registration.metaData.first.attributes.values_at(*metaDataHeaders.map {|x| x.to_sym}) %>
<% registration.finance_details.first.orders.each do |order| %>
<% order_section = order.attributes.values_at(*orderHeaders.map {|x| x.to_sym}) %>
<% order.order_items.each do |orderItem| %>
<% order_item_section = orderItem.attributes.values_at(*orderItemHeaders.map {|x| x.to_sym}) %>
<% related_payments = registration.finance_details.first.payments.to_a.find_all{ |payment| payment.orderKey == order.orderCode } %>
<% row = reg_section + metadata_section + order_section + order_item_section %>
<% if related_payments.nil? || related_payments.empty? %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% else %>
<% related_payments.each do |payment| %>
<% payment_section = payment.attributes.values_at(*paymentHeaders.map {|x| x.to_sym}) %>
<% row += payment_section %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<% end %>
<% end %>
<% end %>
<% order_codes = registration.finance_details.first.orders.collect { |order| order.orderCode } %>
<% unrelated_payments = registration.finance_details.first.payments.to_a.find_all{ |payment| !order_codes.include? payment.orderKey} %>
<% row = reg_section + metadata_section + ["", "", ""] %>
<% unrelated_payments.each do |payment| %>
<% payment_section = payment.attributes.values_at(*paymentHeaders.map {|x| x.to_sym}) %>
<% row += payment_section %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<%end%>
