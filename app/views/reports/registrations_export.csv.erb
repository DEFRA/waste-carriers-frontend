<% headings = [
  t('reports.fields.reg_identifier'),
  t('reports.fields.company_name'),
  t('reports.fields.house_number'),
  t('reports.fields.street_line_1'),
  t('reports.fields.street_line_2'),
  t('reports.fields.street_line_3'),
  t('reports.fields.street_line_4'),
  t('reports.fields.town_city'),
  t('reports.fields.postcode'),
  t('reports.fields.first_name'),
  t('reports.fields.last_name'),
  t('reports.fields.position'),
  t('reports.fields.phone_number'),
  t('reports.fields.contact_email'),
  t('reports.fields.account_email'),
  t('reports.fields.business_type'),
  t('reports.fields.other_businesses'),
  t('reports.fields.is_main_service'),
  t('reports.fields.construction_waste'),
  t('reports.fields.only_amf'),
  t('reports.fields.tier'),
  t('reports.fields.registration_type'),
  t('reports.fields.company_no'),
  t('reports.fields.date_registered'),
  t('reports.fields.date_activated'),
  t('reports.fields.status'),
  t('reports.fields.route'),
  t('reports.fields.access_code'),
  t('reports.fields.expires_on'),
  t('reports.fields.company_match_result'),
  t('reports.fields.company_matched_name'),
  t('reports.fields.company_match_reference'),
  t('reports.fields.declared_convictions'),
  t('reports.fields.key_first_name'),
  t('reports.fields.key_last_name'),
  t('reports.fields.key_dob'),
  t('reports.fields.key_position'),
  t('reports.fields.key_person_type'),
  t('reports.fields.key_match_result'),
  t('reports.fields.key_matched_name'),
  t('reports.fields.key_match_reference'),
  t('reports.fields.key_confirmed')
] %>
<% # Apologies for the formatting in this file, however any formatting such as %>
<% # indenting or line spaces get directly translated to the exported CSV file. %>
<%= CSV.generate_line(headings, { :row_sep => nil, :force_quotes => true }).html_safe %>
<% @registrations.each do |registration| %>
<% if registration.tier == 'UPPER' %>
<% registration.key_people.each do |person| %>
<% row = [] %>
<% row << registration.regIdentifier %>
<% row << registration.companyName %>
<% row << registration.houseNumber %>
<% row << registration.streetLine1 %>
<% row << registration.streetLine2 %>
<% row << registration.streetLine3 %>
<% row << registration.streetLine4 %>
<% row << registration.townCity %>
<% row << registration.postcode %>
<% row << registration.firstName %>
<% row << registration.lastName %>
<% row << registration.position %>
<% row << registration.phoneNumber %>
<% row << registration.contactEmail %>
<% row << registration.accountEmail %>
<% row << registration.businessType %>
<% row << registration.otherBusinesses %>
<% row << registration.isMainService %>
<% row << registration.constructionWaste %>
<% row << registration.onlyAMF %>
<% row << registration.tier %>
<% row << registration.registrationType %>
<% row << registration.company_no %>
<% row << format_as_date_only(registration.metaData.first.dateRegistered) %>
<% row << format_as_date_only(registration.metaData.first.dateActivated) %>
<% row << registration.metaData.first.status %>
<% row << registration.metaData.first.route %>
<% row << registration.accessCode %>
<% row << format_as_date_only(registration.expires_on, blank_if_epoch: true) %>
<% row << registration.conviction_search_result.first.match_result %>
<% row << registration.conviction_search_result.first.matched_name %>
<% row << registration.conviction_search_result.first.get_formatted_reference() %>
<% row << registration.declaredConvictions %>
<% row << person.first_name %>
<% row << person.last_name %>
<% row << format_as_date_only(person.dob) %>
<% row << person.position %>
<% row << person.person_type %>
<% row << person.conviction_search_result.first.match_result %>
<% row << person.conviction_search_result.first.matched_name %>
<% row << person.conviction_search_result.first.get_formatted_reference() %>
<% row << person.conviction_search_result.first.confirmed %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<% else %>
<% row = [] %>
<% row << registration.regIdentifier %>
<% row << registration.companyName %>
<% row << registration.houseNumber %>
<% row << registration.streetLine1 %>
<% row << registration.streetLine2 %>
<% row << registration.streetLine3 %>
<% row << registration.streetLine4 %>
<% row << registration.townCity %>
<% row << registration.postcode %>
<% row << registration.firstName %>
<% row << registration.lastName %>
<% row << registration.position %>
<% row << registration.phoneNumber %>
<% row << registration.contactEmail %>
<% row << registration.accountEmail %>
<% row << registration.businessType %>
<% row << registration.otherBusinesses %>
<% row << registration.isMainService %>
<% row << registration.constructionWaste %>
<% row << registration.onlyAMF %>
<% row << registration.tier %>
<% row << '' %>
<% row << '' %>
<% row << format_as_date_only(registration.metaData.first.dateRegistered) %>
<% row << format_as_date_only(registration.metaData.first.dateActivated) %>
<% row << registration.metaData.first.status %>
<% row << registration.metaData.first.route %>
<% row << registration.accessCode %>
<% row << format_as_date_only(registration.expires_on, blank_if_epoch: true) %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<% row << '' %>
<%= CSV.generate_line(row, {:row_sep => nil, :force_quotes => true}).html_safe %>
<% end %>
<% end %>
