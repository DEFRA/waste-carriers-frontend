<%= render 'shared/content_for_pages' %>

<div id="wrapper">

<main id="content" role="main" class="group">

  <header class="page-header group">
    <div class="hgroup">
      <h1 class="heading-xlarge"><%= t '.subtitle' %></h1>
      <% if params[:error] %>
        <div id="error_explanation" class="validation-summary">
          <h2 class="heading-medium"><%= params[:error]%></h2>
        </div>
      <% end %>
      <% if !notice.nil? %>
        <h2 class="heading-medium"><%= notice%></h2>
      <% end %>
      <% if params[:note] %>
        <h2 class="heading-medium"><%= params[:note]%></h2>
      <% end %>
    </div>
  </header>

  <div class="grid-wrapper">

  <div class="grid-2-3">
    <div class="inner-block">
        <!-- WF 4.3.2 -->
        <div id="page0"  data-journey="waste-carriers-registration:agency-user-controls">
          <% content_for :page_title, createTitle('.title') %></div>
          <%= form_tag('/registrations', { method: :get }) do %>

            <fieldset id='find-registration'>
              <div class="form-group">
                <%= label_tag 'query-label', t('.query_label'), { class: 'form-label', for: 'q'} %>
                <%= text_field_tag 'q', params[:q], { id: 'q', size: 20 } %>
              </div>

              <div id="advanced-options" style="<% if params[:searchWithin].nil? || params[:searchWithin] == 'any' %>display:none<% end %>">
                <div class="form-group">
                  <%= label_tag 'search-within-label', t('.search_within_label'), { class: 'form-label', for: 'searchWithin' } %>
                  <% options = { "#{t('.option_any')}" => 'any', "#{t('.option_company_name')}" => 'companyName', "#{t('.option_contact_name')}" => 'contactName', "#{t('.option_postcode')}" => 'postcode' } %>
                  <% selected = if params[:searchWithin].nil? || params[:searchWithin] == 'any' %>
                    <% t '.option_any' %>
                  <% elsif params[:searchWithin] == 'companyName' %>
                    <% t '.option_company_name' %>
                  <% elsif params[:searchWithin] == 'contactName' %>
                    <% t '.option_contact_name' %>
                  <% elsif params[:searchWithin] == 'postcode' %>
                    <% t '.option_postcode' %>
                  <% end %>
                  <%= select_tag 'searchWithin', options_for_select(options, selected) %>
                </div>
              </div>

            </fieldset>

            <a href="#" id="toggle-search">
              <% if params[:searchWithin].nil? || params[:searchWithin] == 'any' %>
                <%= t '.refine_search_link_label' %>
              <% else %>
                <%= t '.full_search_link_label' %>
              <% end %>
            </a>
            <div class="next_link">
              <%= submit_tag(t('form.search_button_label'), { id: 'reg-search', class: 'button button-get-started' })  %>
            </div>
          <% end %>

          <% if params[:q]%>
            <div id="reg-search-result" style="">
              <h2><%= t('.results_count_message', :pluralized_registration => pluralize(@registrations.count, t('.registration'))) %></h2>
              <p><%= t('.results_showing_message', :count => @registrations.count, :pluralized_record => pluralize(@registrations.count, t('.record'))) %>
            </div>

            <table summary='A summary of the first 100 registrations matching your search' role='presentation'>
              <thead>
                <tr>
                  <th><%= t '.company_name' %></th>
                  <th><%= t 'activemodel.attributes.registration.postcode' %></th>
                  <th><%= t 'activemodel.attributes.registration.tier' %></th>
                  <th><%= t 'activemodel.attributes.metadata.dateRegistered' %></th>
                  <th><%= t 'activemodel.attributes.metadata.status' %></th>
                  <th>&nbsp;</th>
                  <th>&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                <% regCount = 1 %>
                <% @registrations.each do |reg| %>
                  <tr>
                    <td><%= reg.companyName %></td>
                    <td><%= reg.postcode %></td>
                    <td><%= reg.tier %></td>
                    <td><%= reg.metaData.first.dateRegistered %></td>
                    <td><%= reg.metaData.first.status %></td>
                    <td>
                      <%= form_tag ncccedit_url(reg.id) do %>
                        <%= submit_tag t('form.edit_button_label'), { class: 'button' }  %>
                      <% end %>
                    </td>
                    <% if reg.try(:tier).try(:downcase) == "upper" %>
                      <td>
                        <%= form_tag(paymentstatus_url(reg.uuid), { method: :get }) do %>
                          <%= submit_tag t('form.payment_status_button_label'), { id: "paymentStatus#{regCount}",class: 'button' }  %>
                        <% end %>
                      </td>
                    <% end %>
                  </tr>
                  <% regCount = regCount + 1 %>
                <% end %>
              </tbody>
            </table>
          <% end %>

    </div><!-- end inner-block -->
  </div><!-- end grid 2-3-->

  <div class="grid-1-3">
    <div class="inner-block related">
      <div class="inner group related-subsection">
        <h2 class="heading-small">Current user</h2>
          <nav aria-labelledby="parent-subsection" role="navigation">
            <ul>
              <li><%= render "shared/current_user" %></li>
            </ul>
          </nav>
        </div>
      </div>
    </div><!-- end grid 1-3-->

    </div><!-- end grid-wrapper -->

  </main><!-- end main -->
</div><!-- end wrapper -->
